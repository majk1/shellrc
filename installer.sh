#!/usr/bin/env bash

getLatestVersion() {
    if type -p curl 2>&1 >/dev/null; then
        VERSIONS="$(curl -L -s -o- 'https://github.com/majk1/shellrc/releases' | grep "/majk1/shellrc/archive/.*\.tar\.gz" | sed '/\/majk1\/shellrc\/archive\/refs\/tags\/.*\.tar\.gz/s/.*href="\/majk1\/shellrc\/archive\/refs\/tags\/\([0-9\.]*\)\.tar\.gz".*/\1/' | sort -Vr)"
    elif type -p wget 2>&1 >/dev/null; then
        VERSIONS="$(wget --no-cache -q -O- 'https://github.com/majk1/shellrc/releases' | grep "/majk1/shellrc/archive/.*\.tar\.gz" | sed '/\/majk1\/shellrc\/archive\/refs\/tags\/.*\.tar\.gz/s/.*href="\/majk1\/shellrc\/archive\/refs\/tags\/\([0-9\.]*\)\.tar\.gz".*/\1/' | sort -Vr)"
    else
        echo "Could not query latest version, curl or wget cannot be found :(" >&2
        return 1
    fi
    local LATEST="$(echo "$VERSIONS" | head -n 1)"
    echo "${LATEST}"
}

LATEST_VERSION="$(getLatestVersion)"
RET=$?
if [ $RET -ne 0 ]; then
    exit $RET
fi

getArchiveDirectoryName() {
    echo "shellrc-$(tar -tvzf "$1" | head -n 1 | sed 's/.*shellrc-\([^\/]*\)\/.*/\1/')"
}

SILENT=0

log() {
    if [ $SILENT -eq 0 ]; then
        echo "$@"
    fi
}

err() {
    echo "$@" >&2
}

download() {
    log "Installing/upgrading scripts version $LATEST_VERSION"
    ARCHIVE_DIR="$(mktemp -d -t "shellrc-scripts-XXXX")"
    log "Created temp directory: $ARCHIVE_DIR"
    if type -p wget 2>&1 >/dev/null; then
        log "Using wget to fetch archive"
        wget -q -O "${ARCHIVE_DIR}/${LATEST_VERSION}.tar.gz" "https://github.com/majk1/shellrc/archive/${LATEST_VERSION}.tar.gz"
    elif type -p curl 2>&1 >/dev/null; then
        log "Using curl to fetch archive"
        curl -L -s -o "${ARCHIVE_DIR}/${LATEST_VERSION}.tar.gz" "https://github.com/majk1/shellrc/archive/${LATEST_VERSION}.tar.gz"
    else
        err "Cannot download archive, no wget or curl has been found :("
        rm -rf "$ARCHIVE_DIR"
        exit 1
    fi
    if [ $? -ne 0 ]; then
        err "Could not download archive from url: https://github.com/majk1/shellrc/archive/${LATEST_VERSION}.tar.gz"
        rm -rf "$ARCHIVE_DIR"
        exit 2
    fi
    DIR_NAME="$(getArchiveDirectoryName "${ARCHIVE_DIR}/${LATEST_VERSION}.tar.gz")"
    if [ ! -z "$DIR_NAME" ]; then
        log "Extracting archive ${ARCHIVE_DIR}/${DIR_NAME}"
        tar -C "$ARCHIVE_DIR" -xzf "${ARCHIVE_DIR}/${LATEST_VERSION}.tar.gz" 2>&1 >/dev/null
        if [ $? -ne 0 ]; then
            err "Cannot extract archive :("
            rm -rf "$ARCHIVE_DIR"
            exit 4
        else
            INSTALL_DIR=$SCRIPT_BASE_DIR
            if [ ! -z "${INSTALL_DIR}" ]; then
                log "Script base already exists at ${INSTALL_DIR}, cleaning"
                rm -rf ${INSTALL_DIR}/*
                log "Moving extracted archive to ${INSTALL_DIR}"
                mv ${ARCHIVE_DIR}/${DIR_NAME}/* "${INSTALL_DIR}/"
            else
                INSTALL_DIR="${HOME}/.scripts"
                log "Creating script base ${INSTALL_DIR}"
                mkdir "${INSTALL_DIR}" 2>&1 >/dev/null
                if [ $? -ne 0 ]; then
                    err "Could not create script base directory: ${INSTALL_DIR} :("
                    rm -rf "$ARCHIVE_DIR"
                    exit 5
                fi
                log "Moving extracted archive to ${INSTALL_DIR}"
                mv ${ARCHIVE_DIR}/${DIR_NAME}/* "${INSTALL_DIR}/"
            fi
            log "Clearing temp dir ${ARCHIVE_DIR}"
            rm -rf "$ARCHIVE_DIR"
        fi
    else
        err "Could not get archive dir name :("
        rm -rf "$ARCHIVE_DIR"
        exit 3
    fi

    if [ -f "${HOME}/.bashrc" ]; then
        if [ ! -f "${HOME}/.bashrc.backup" ]; then
            log "Backing up existing .bashrc file"
            mv "${HOME}/.bashrc" "${HOME}/.bashrc.backup"
        else
            log "Backup .bashrc file already exists, not backing up"
        fi
        log "Generating ${HOME}.bashrc"
        cat << EOF > "${HOME}/.bashrc"
# Generated by shellrc-scripts version ${LATEST_VERSION}
export SHELLRC_VERSION="${LATEST_VERSION}"
source "${INSTALL_DIR}/shellrc.sh"
EOF
    fi

    if [ -f "${HOME}/.zshrc" ]; then
        if [ ! -f "${HOME}/.zshrc.backup" ]; then
            log "Backing up existing .zshrc file"
            mv "${HOME}/.zshrc" "${HOME}/.zshrc.backup"
        else
            log "Backup .zshrc file already exists, not backing up"
        fi
        log "Generating ${HOME}.zshrc"
        cat << EOF > "${HOME}/.zshrc"
# Generated by shellrc-scripts version ${LATEST_VERSION}
export SHELLRC_VERSION="${LATEST_VERSION}"
source "${INSTALL_DIR}/shellrc.sh"
EOF
    fi

    log "Installation of scripts (ver ${LATEST_VERSION}) has finished successfully"
}

if [ ! -z "$1" ]; then
    case "$1" in
        "-a")
            if [ ! -z "$SHELLRC_VERSION" ]; then
                if [ "$SHELLRC_VERSION" != "$LATEST_VERSION" ]; then
                    echo "$LATEST_VERSION"
                fi
            else
                echo "$LATEST_VERSION"
            fi
        ;;
        "-u")
            download
        ;;
        "-su")
            SILENT=1
            download
        ;;
    esac
fi
